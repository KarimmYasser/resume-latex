name: ğŸ“„ LaTeX Resume CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - "**.tex"
      - "**.cls"
      - "**.sty"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "**.tex"
      - "**.cls"
      - "**.sty"
  workflow_dispatch: # Allow manual trigger

# Grant necessary permissions for the workflow
permissions:
  contents: write # Needed to create releases and upload assets
  actions: read # Needed to download artifacts
  checks: read # Needed for status checks

jobs:
  compile-resume:
    name: ğŸ”¨ Compile LaTeX Resume
    runs-on: ubuntu-latest

    strategy:
      matrix:
        theme:
          [
            { name: "light", file: "resume.tex", output: "resume-light.pdf" },
            {
              name: "dark",
              file: "resume-dark.tex",
              output: "resume-dark.pdf",
            },
          ]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup LaTeX Environment
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ matrix.theme.file }}
          latexmk_use_xelatex: false
          latexmk_shell_escape: true
          extra_system_packages: |
            py3-pygments

      - name: ğŸ“ Rename Output PDF
        run: |
          if [ -f "${{ matrix.theme.file }}" ]; then
            # Get the base filename without extension
            base_name=$(basename "${{ matrix.theme.file }}" .tex)
            # Check if renaming is needed (avoid renaming to same file)
            if [ "${base_name}.pdf" != "${{ matrix.theme.output }}" ]; then
              if [ -f "${base_name}.pdf" ]; then
                mv "${base_name}.pdf" "${{ matrix.theme.output }}"
                echo "âœ… Renamed: ${base_name}.pdf â†’ ${{ matrix.theme.output }}"
              else
                echo "âŒ PDF not found: ${base_name}.pdf"
                exit 1
              fi
            else
              # PDF already has the correct name
              if [ -f "${{ matrix.theme.output }}" ]; then
                echo "âœ… Generated: ${{ matrix.theme.output }} (no rename needed)"
              else
                echo "âŒ PDF not found: ${{ matrix.theme.output }}"
                exit 1
              fi
            fi
          else
            echo "âŒ Source file not found: ${{ matrix.theme.file }}"
            exit 1
          fi

      - name: ğŸ“Š Check PDF Properties
        run: |
          if [ -f "${{ matrix.theme.output }}" ]; then
            echo "ğŸ“„ PDF Information for ${{ matrix.theme.name }} theme:"
            pdfinfo "${{ matrix.theme.output }}" || true
            echo "ğŸ“ File size: $(du -h "${{ matrix.theme.output }}" | cut -f1)"
          fi

      - name: ğŸ“¤ Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-${{ matrix.theme.name }}-theme
          path: ${{ matrix.theme.output }}
          retention-days: 90

  create-release:
    name: ğŸš€ Create Release with PDFs
    needs: compile-resume
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write # Explicit permission for this job to create releases
      actions: read # Permission to download artifacts

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Light Theme PDF
        uses: actions/download-artifact@v4
        with:
          name: resume-light-theme
          path: ./artifacts/

      - name: ğŸ“¥ Download Dark Theme PDF
        uses: actions/download-artifact@v4
        with:
          name: resume-dark-theme
          path: ./artifacts/

      - name: ğŸ” List Downloaded Files
        run: |
          echo "ğŸ“‹ Files in artifacts directory:"
          find ./artifacts/ -type f -name "*.pdf" -exec ls -la {} \;
          echo "ğŸ“‚ Directory structure:"
          find ./artifacts/ -type f

      - name: ğŸ“„ Prepare PDFs for Release
        run: |
          # Ensure PDFs are in the correct location
          mkdir -p ./release-assets/

          # Find and copy PDFs to release directory
          find ./artifacts/ -name "resume-light.pdf" -exec cp {} ./release-assets/resume-light.pdf \;
          find ./artifacts/ -name "resume-dark.pdf" -exec cp {} ./release-assets/resume-dark.pdf \;

          # Verify files exist
          echo "ğŸ“„ PDFs prepared for release:"
          ls -la ./release-assets/

          # Validate PDFs are not empty
          for pdf in ./release-assets/*.pdf; do
            if [ -f "$pdf" ]; then
              size=$(du -h "$pdf" | cut -f1)
              echo "âœ… $(basename "$pdf"): $size"
            else
              echo "âŒ Missing: $(basename "$pdf")"
              exit 1
            fi
          done

      - name: ğŸ·ï¸ Generate Release Tag
        id: tag
        run: |
          # Generate timestamp-based tag
          TAG="v$(date +'%Y.%m.%d')-$(date +'%H%M')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      - name: ğŸ“‹ Generate Release Notes
        id: release_notes
        run: |
          # Generate simple release notes as a single line (avoid multi-line issues)
          SIMPLE_NOTES="ğŸ“„ Resume Update - $(date +'%B %d, %Y'). Includes Light Theme (ATS-optimized) and Dark Theme (digital portfolio) PDFs. Commit: ${{ github.sha }}"
          echo "NOTES=$SIMPLE_NOTES" >> $GITHUB_OUTPUT
          echo "Generated release notes: $SIMPLE_NOTES"

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Resume - ${{ steps.tag.outputs.tag }}"
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: |
            ./release-assets/resume-light.pdf
            ./release-assets/resume-dark.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-pdfs:
    name: ğŸ” Validate Generated PDFs
    needs: compile-resume
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./pdfs/

      - name: ï¿½ Install PDF Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: ï¿½ğŸ” Validate PDFs
        run: |
          echo "ğŸ” Validating generated PDFs..."

          for theme_dir in ./pdfs/resume-*-theme/; do
            if [ -d "$theme_dir" ]; then
              theme_name=$(basename "$theme_dir" | sed 's/resume-\(.*\)-theme/\1/')
              echo "ğŸ“„ Checking $theme_name theme..."
              
              for pdf in "$theme_dir"/*.pdf; do
                if [ -f "$pdf" ]; then
                  echo "  âœ… Found: $(basename "$pdf")"
                  
                  # Check if PDF is valid
                  if pdfinfo "$pdf" > /dev/null 2>&1; then
                    echo "  âœ… PDF is valid"
                    
                    # Check file size (should be reasonable for a resume)
                    size=$(du -k "$pdf" | cut -f1)
                    if [ "$size" -gt 50 ] && [ "$size" -lt 5000 ]; then
                      echo "  âœ… File size OK: ${size}KB"
                    else
                      echo "  âš ï¸  Unusual file size: ${size}KB"
                    fi
                    
                    # Check page count (should be 1-3 pages for a resume)
                    pages=$(pdfinfo "$pdf" 2>/dev/null | grep "Pages:" | awk '{print $2}' || echo "1")
                    if [ "$pages" -ge 1 ] && [ "$pages" -le 3 ]; then
                      echo "  âœ… Page count OK: $pages pages"
                    else
                      echo "  âš ï¸  Unusual page count: $pages pages"
                    fi
                  else
                    echo "  âŒ PDF validation failed - running diagnostics..."
                    echo "  ğŸ” File details:"
                    ls -la "$pdf"
                    echo "  ğŸ” File type:"
                    file "$pdf"
                    echo "  ğŸ” PDF info output:"
                    pdfinfo "$pdf" 2>&1 || true
                    echo "  âŒ Stopping validation due to invalid PDF"
                    exit 1
                  fi
                else
                  echo "  âŒ No PDF found in $theme_dir"
                  exit 1
                fi
              done
            fi
          done

          echo "ğŸ‰ All PDFs validated successfully!"

  notify-status:
    name: ğŸ“¢ Notify Build Status
    needs: [compile-resume, validate-pdfs]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¢ Build Success Notification
        if: needs.compile-resume.result == 'success' && needs.validate-pdfs.result == 'success'
        run: |
          echo "ğŸ‰ Resume compilation successful!"
          echo "âœ… Light theme PDF generated"
          echo "âœ… Dark theme PDF generated"
          echo "âœ… All validations passed"

      - name: ğŸ“¢ Build Failure Notification
        if: needs.compile-resume.result == 'failure' || needs.validate-pdfs.result == 'failure'
        run: |
          echo "âŒ Resume compilation failed!"
          echo "Please check the logs for details."
          exit 1
